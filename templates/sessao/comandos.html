{% extends "base.html" %}

{% block title %}Comandos - {{ sessao.nome }} - Fluxi.IA{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="margin-bottom: 2rem;">
    <nav class="breadcrumb" aria-label="breadcrumbs" style="margin-bottom: 0.75rem !important;">
        <ul style="margin-bottom: 0 !important;">
            <li><a href="/sessoes" style="color: #6b7280;"><i class="fas fa-home"></i> Sessões</a></li>
            <li><a href="/sessoes/{{ sessao.id }}/detalhes" style="color: #6b7280;">{{ sessao.nome }}</a></li>
            <li class="is-active"><a style="color: #C75B9B;">Comandos</a></li>
        </ul>
    </nav>
    <h1 class="title is-3" style="margin-bottom: 0.75rem !important; line-height: 1.2;">
        <i class="fas fa-terminal" style="color: #8b5cf6;"></i> Comandos Personalizáveis
    </h1>
    <p class="subtitle is-6" style="color: #6b7280; margin-bottom: 0 !important; line-height: 1.4;">
        Configure os comandos disponíveis para os usuários na sessão <strong>{{ sessao.nome }}</strong>
    </p>
</div>

<div class="columns">
    <div class="column is-8">
        <form method="POST" action="/sessoes/{{ sessao.id }}/comandos/salvar">
            
            {% for cmd_id, cmd in comandos.items() %}
            <div class="box" style="margin-bottom: 1.5rem; border-left: 4px solid {% if cmd.ativo %}#8b5cf6{% else %}#d1d5db{% endif %};">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; border-radius: 8px; background: {% if cmd.ativo %}#8b5cf6{% else %}#9ca3af{% endif %}; display: flex; align-items: center; justify-content: center;">
                            {% if cmd_id == 'ativar' %}
                            <i class="fas fa-play-circle" style="color: white;"></i>
                            {% elif cmd_id == 'desativar' %}
                            <i class="fas fa-pause-circle" style="color: white;"></i>
                            {% elif cmd_id == 'limpar' %}
                            <i class="fas fa-broom" style="color: white;"></i>
                            {% elif cmd_id == 'ajuda' %}
                            <i class="fas fa-question-circle" style="color: white;"></i>
                            {% elif cmd_id == 'status' %}
                            <i class="fas fa-info-circle" style="color: white;"></i>
                            {% elif cmd_id == 'listar' %}
                            <i class="fas fa-list" style="color: white;"></i>
                            {% elif cmd_id == 'trocar_agente' %}
                            <i class="fas fa-exchange-alt" style="color: white;"></i>
                            {% else %}
                            <i class="fas fa-terminal" style="color: white;"></i>
                            {% endif %}
                        </div>
                        <div>
                            <strong style="color: #1f2937; font-size: 1.1rem;">{{ cmd_id|replace('_', ' ')|title }}</strong>
                            <p style="color: #6b7280; font-size: 0.875rem; margin: 0;">{{ cmd.descricao }}</p>
                        </div>
                    </div>
                    <label class="switch" style="position: relative; display: inline-block; width: 50px; height: 26px;">
                        <input type="checkbox" name="cmd_{{ cmd_id }}_ativo" value="true" {% if cmd.ativo %}checked{% endif %} style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: {% if cmd.ativo %}#8b5cf6{% else %}#ccc{% endif %}; transition: .3s; border-radius: 26px;"></span>
                    </label>
                </div>
                
                <div class="columns" style="margin-top: 1rem;">
                    <div class="column is-4">
                        <label class="label" style="font-size: 0.875rem; color: #374151;">
                            <i class="fas fa-hashtag"></i> Gatilho
                        </label>
                        <input type="text" class="input" name="cmd_{{ cmd_id }}_gatilho" 
                               value="{{ cmd.gatilho }}" 
                               placeholder="Ex: #limpar, @limpar"
                               style="border-radius: 6px;">
                        {% if cmd_id == 'trocar_agente' %}
                        <p class="help">Prefixo + código do agente (ex: #01)</p>
                        {% endif %}
                    </div>
                    <div class="column is-8">
                        <label class="label" style="font-size: 0.875rem; color: #374151;">
                            <i class="fas fa-comment-alt"></i> Descrição (aparece no #ajuda)
                        </label>
                        <input type="text" class="input" name="cmd_{{ cmd_id }}_descricao" 
                               value="{{ cmd.descricao }}"
                               placeholder="Descrição do comando"
                               style="border-radius: 6px;">
                    </div>
                </div>
                
                {% if cmd_id in ['ativar', 'desativar', 'limpar', 'trocar_agente'] %}
                <div class="field" style="margin-top: 1rem;">
                    <label class="label" style="font-size: 0.875rem; color: #374151;">
                        <i class="fas fa-reply"></i> Mensagem de Resposta
                    </label>
                    <textarea class="textarea" name="cmd_{{ cmd_id }}_resposta" rows="3" 
                              placeholder="Mensagem enviada ao usuário..."
                              style="border-radius: 6px; font-family: monospace;">{{ cmd.resposta or '' }}</textarea>
                    {% if cmd_id == 'trocar_agente' %}
                    <p class="help">
                        Variáveis: <code>{agente_nome}</code>, <code>{agente_descricao}</code>, <code>{agente_papel}</code>
                    </p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}

            <!-- Botões -->
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 2rem;">
                <button type="submit" class="button is-primary is-medium" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border: none; border-radius: 8px; font-weight: 600; padding: 0.75rem 2rem;">
                    <span class="icon"><i class="fas fa-save"></i></span>
                    <span>Salvar Comandos</span>
                </button>
                <a href="/sessoes/{{ sessao.id }}/detalhes" class="button is-medium" style="border-radius: 8px; font-weight: 600; padding: 0.75rem 2rem;">
                    <span class="icon"><i class="fas fa-arrow-left"></i></span>
                    <span>Voltar</span>
                </a>
            </div>
        </form>
    </div>

    <!-- Sidebar de Ajuda -->
    <div class="column is-4">
        <div class="box" style="position: sticky; top: 2rem; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border: 2px solid #e5e7eb;">
            <h3 class="title is-5" style="margin-bottom: 1rem;">
                <i class="fas fa-lightbulb" style="color: #f59e0b;"></i> Dicas
            </h3>
            
            <div style="display: grid; gap: 1rem;">
                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 3px solid #8b5cf6;">
                    <p style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                        <i class="fas fa-hashtag"></i> Gatilhos
                    </p>
                    <p style="font-size: 0.875rem; color: #6b7280;">
                        Use qualquer prefixo: <code>#</code>, <code>@</code>, <code>/</code>, <code>!</code>
                    </p>
                </div>

                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 3px solid #10b981;">
                    <p style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                        <i class="fas fa-toggle-on"></i> Ativar/Desativar
                    </p>
                    <p style="font-size: 0.875rem; color: #6b7280;">
                        Comandos desativados são ignorados silenciosamente.
                    </p>
                </div>

                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 3px solid #f59e0b;">
                    <p style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                        <i class="fas fa-code"></i> Variáveis
                    </p>
                    <p style="font-size: 0.875rem; color: #6b7280;">
                        Use <code>{variavel}</code> para inserir dados dinâmicos nas respostas.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.switch input:checked + span {
    background-color: #8b5cf6 !important;
}
.switch input:checked + span:before {
    transform: translateX(24px);
}
.switch span:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
}
</style>
{% endblock %}
