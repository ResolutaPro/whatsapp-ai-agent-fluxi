{% extends "base.html" %}

{% block title %}Configuraﾃｧﾃｵes - Fluxi.IA{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="margin-bottom: 2rem;">
    <h1 class="title is-3" style="margin-bottom: 0.75rem !important; line-height: 1.2;">
        <i class="fas fa-cog" style="color: #8b5cf6;"></i> Configuraﾃｧﾃｵes do Sistema
    </h1>
    <p class="subtitle is-6" style="color: #6b7280; margin-bottom: 0 !important; line-height: 1.4;">
        Configure API, parﾃ｢metros de IA e preferﾃｪncias do sistema
    </p>
</div>
<!-- Provedores LLM -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fas fa-server" style="color: #8b5cf6;"></i> Provedores LLM
    </h2>
    
    <form method="POST" action="/configuracoes/salvar-provedores-llm">
        <div class="field">
            <label class="label" style="color: #374151; font-weight: 600; margin-bottom: 0.5rem;">
                <i class="fas fa-cog"></i> Provedor Padrﾃ｣o
            </label>
            <div class="control">
                <div class="select is-fullwidth">
                    <select name="provedor_padrao" id="provedor_padrao" style="border-radius: 8px; border: 2px solid #e5e7eb; padding: 0.75rem 1rem;" onchange="atualizarProvedorLocal()">
                        <option value="auto" {% if (config_llm|selectattr('chave', 'equalto', 'llm_provedor_padrao')|map(attribute='valor')|first or 'auto') == 'auto' %}selected{% endif %}>
                            Automﾃ｡tico (usa primeiro disponﾃｭvel)
                        </option>
                        <option value="local" {% if (config_llm|selectattr('chave', 'equalto', 'llm_provedor_padrao')|map(attribute='valor')|first) == 'local' %}selected{% endif %}>
                            Provedor Local Especﾃｭfico
                        </option>
                        <option value="openrouter" {% if (config_llm|selectattr('chave', 'equalto', 'llm_provedor_padrao')|map(attribute='valor')|first) == 'openrouter' %}selected{% endif %}>
                            OpenRouter (Nuvem)
                        </option>
                    </select>
                </div>
            </div>
            <p class="help" style="color: #6b7280; margin-top: 0.5rem;">
                <strong>Automﾃ｡tico:</strong> Usa provedores locais primeiro, depois OpenRouter se disponﾃｭvel<br>
                <strong>Local:</strong> Usa apenas o provedor local selecionado<br>
                <strong>OpenRouter:</strong> Usa apenas OpenRouter (requer API Key)
            </p>
        </div>
        
        <div class="field" id="provedor_local_field" style="display: none;">
            <label class="label" style="color: #374151; font-weight: 600; margin-bottom: 0.5rem;">
                <i class="fas fa-server"></i> Provedor Local
            </label>
            <div class="control">
                <div class="select is-fullwidth">
                    <select name="provedor_local_id" style="border-radius: 8px; border: 2px solid #e5e7eb; padding: 0.75rem 1rem;">
                        <option value="">-- Selecione um provedor --</option>
                        {% for provedor in provedores_locais %}
                        <option value="{{ provedor.id }}" {% if (config_llm|selectattr('chave', 'equalto', 'llm_provedor_local_id')|map(attribute='valor')|first) == provedor.id|string %}selected{% endif %}>
                            {{ provedor.nome }} ({{ provedor.base_url }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <p class="help" style="color: #6b7280; margin-top: 0.5rem;">
                Selecione qual provedor local usar. <a href="/provedores-llm/novo" style="color: #C75B9B;">Criar novo provedor</a>
            </p>
        </div>
        
        <div class="field">
            <label class="label" style="color: #374151; font-weight: 600; margin-bottom: 0.5rem;">
                <i class="fas fa-shield-alt"></i> Fallback para OpenRouter
            </label>
            <div class="control">
                <label class="checkbox">
                    <input type="checkbox" name="fallback_openrouter" value="true" 
                           {% if (config_llm|selectattr('chave', 'equalto', 'llm_fallback_openrouter')|map(attribute='valor')|first or 'true') == 'true' %}checked{% endif %}>
                    Usar OpenRouter como fallback quando provedor local falhar
                </label>
            </div>
        </div>
        
        <div class="field is-grouped">
            <div class="control">
                <button type="submit" class="button is-primary">
                    <span class="icon">
                        <i class="fas fa-save"></i>
                    </span>
                    <span>Salvar Configuraﾃｧﾃｵes</span>
                </button>
            </div>
            <div class="control">
                <a href="/provedores-llm" class="button is-light">
                    <span class="icon">
                        <i class="fas fa-server"></i>
                    </span>
                    <span>Gerenciar Provedores</span>
                </a>
            </div>
        </div>
    </form>
</div>

<!-- OpenRouter API -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fas fa-key" style="color: #f59e0b;"></i> OpenRouter API
    </h2>
        
        <form method="POST" action="/configuracoes/salvar-openrouter">
        <div class="field">
            <label class="label" style="color: #374151; font-weight: 600; margin-bottom: 0.5rem;">
                <i class="fas fa-key"></i> API Key *
            </label>
            <div class="control has-icons-left">
                <input class="input" type="password" name="api_key" placeholder="sk-or-v1-..." 
                       value="{{ config_openrouter|selectattr('chave', 'equalto', 'openrouter_api_key')|map(attribute='valor')|first or '' }}"
                       style="border-radius: 8px; border: 2px solid #e5e7eb; padding: 0.75rem 1rem; font-family: monospace;">
                <span class="icon is-small is-left" style="color: #f59e0b;">
                    <i class="fas fa-key"></i>
                </span>
            </div>
            <p class="help" style="color: #6b7280; margin-top: 0.5rem;">
                沐 Obtenha em <a href="https://openrouter.ai/keys" target="_blank" style="color: #C75B9B; font-weight: 600;">openrouter.ai/keys</a>
            </p>
        </div>
            
        <div class="field">
            <label class="label" style="color: #374151; font-weight: 600; margin-bottom: 0.5rem;">
                <i class="fas fa-brain"></i> Modelo Padrﾃ｣o
            </label>
            <div class="control">
                <input class="input" type="text" name="modelo_padrao" placeholder="google/gemini-2.0-flash-001"
                       value="{{ config_openrouter|selectattr('chave', 'equalto', 'openrouter_modelo_padrao')|map(attribute='valor')|first or '' }}"
                       style="border-radius: 8px; border: 2px solid #e5e7eb; padding: 0.75rem 1rem; font-family: monospace;">
            </div>
            <p class="help" style="color: #6b7280; margin-top: 0.5rem;">
                Ex: google/gemini-2.0-flash-001, openai/gpt-4, anthropic/claude-3.5-sonnet
            </p>
        </div>
            
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button type="submit" name="acao" value="testar" class="button is-medium" style="border: 2px solid #3b82f6; color: #3b82f6; font-weight: 600; border-radius: 8px;">
                <span class="icon"><i class="fas fa-plug"></i></span>
                <span>Testar Conexﾃ｣o</span>
            </button>
            <button type="submit" name="acao" value="salvar" class="button is-medium" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; font-weight: 600; border-radius: 8px;">
                <span class="icon"><i class="fas fa-save"></i></span>
                <span>Salvar</span>
            </button>
        </div>
        </form>
    </div>

<!-- Parﾃ｢metros LLM -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fas fa-sliders-h" style="color: #8b5cf6;"></i> Parﾃ｢metros IA Padrﾃ｣o
    </h2>
        
        <form method="POST" action="/configuracoes/salvar-parametros-llm">
            <div class="columns">
                <div class="column">
                    <div class="field">
                        <label class="label">Temperatura (0.0 - 2.0)</label>
                        <div class="control">
                            <input class="input" type="number" step="0.1" min="0" max="2" 
                                   name="temperatura"
                                   value="{{ config_openrouter|selectattr('chave', 'equalto', 'openrouter_temperatura')|map(attribute='valor')|first or '0.7' }}">
                        </div>
                        <p class="help">Controla a criatividade das respostas</p>
                    </div>
                </div>
                
                <div class="column">
                    <div class="field">
                        <label class="label">Max Tokens</label>
                        <div class="control">
                            <input class="input" type="number" step="100" min="100" max="8001" 
                                   name="max_tokens"
                                   value="{{ config_openrouter|selectattr('chave', 'equalto', 'openrouter_max_tokens')|map(attribute='valor')|first or '2000' }}">
                        </div>
                        <p class="help">Tamanho mﾃ｡ximo da resposta</p>
                    </div>
                </div>
                
                <div class="column">
                    <div class="field">
                        <label class="label">Top P (0.0 - 1.0)</label>
                        <div class="control">
                            <input class="input" type="number" step="0.1" min="0" max="1" 
                                   name="top_p"
                                   value="{{ config_openrouter|selectattr('chave', 'equalto', 'openrouter_top_p')|map(attribute='valor')|first or '1.0' }}">
                        </div>
                        <p class="help">Controla a diversidade</p>
                    </div>
                </div>
            </div>
            
            <div class="columns">
                <div class="column">
                    <div class="field">
                        <label class="label">Frequency Penalty (-2.0 a 2.0)</label>
                        <div class="control">
                            <input class="input" type="number" step="0.1" min="-2" max="2" 
                                   name="frequency_penalty"
                                   value="{{ config_openrouter|selectattr('chave', 'equalto', 'openrouter_frequency_penalty')|map(attribute='valor')|first or '0.0' }}">
                        </div>
                        <p class="help">Evita repetiﾃｧﾃ｣o de palavras frequentes</p>
                    </div>
                </div>
                
                <div class="column">
                    <div class="field">
                        <label class="label">Presence Penalty (-2.0 a 2.0)</label>
                        <div class="control">
                            <input class="input" type="number" step="0.1" min="-2" max="2" 
                                   name="presence_penalty"
                                   value="{{ config_openrouter|selectattr('chave', 'equalto', 'openrouter_presence_penalty')|map(attribute='valor')|first or '0.0' }}">
                        </div>
                        <p class="help">Incentiva novos tﾃｳpicos na conversa</p>
                    </div>
                </div>
            </div>
            
        <div class="field">
            <div class="control">
                <button type="submit" class="button is-medium" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; font-weight: 600; border-radius: 8px;">
                    <span class="icon"><i class="fas fa-save"></i></span>
                    <span>Salvar Parﾃ｢metros</span>
                </button>
            </div>
        </div>
        </form>
    </div>

<!-- Configuraﾃｧﾃｵes do Agente Padrﾃ｣o -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fas fa-robot" style="color: #5B4E9B;"></i> Agente Padrﾃ｣o (Template)
    </h2>
    <p style="color: #6b7280; margin-bottom: 1.5rem; line-height: 1.7;">
        <i class="fas fa-info-circle"></i> Estes valores serﾃ｣o usados ao criar novos agentes
    </p>
        
        <form method="POST" action="/configuracoes/salvar-agente">
            <div class="field">
                <label class="label">Papel</label>
                <div class="control">
                    <input class="input" type="text" name="papel" 
                           value="{{ config_agente|selectattr('chave', 'equalto', 'agente_papel_padrao')|map(attribute='valor')|first or 'assistente pessoal' }}">
                </div>
                <p class="help">Quem o agente ﾃｩ (ex: "consultor de vendas", "assistente pessoal")</p>
            </div>
            
            <div class="field">
                <label class="label">Objetivo</label>
                <div class="control">
                    <textarea class="textarea" name="objetivo" rows="2">{{ config_agente|selectattr('chave', 'equalto', 'agente_objetivo_padrao')|map(attribute='valor')|first or 'ajudar o usuﾃ｡rio com suas dﾃｺvidas e tarefas' }}</textarea>
                </div>
                <p class="help">Missﾃ｣o principal do agente</p>
            </div>
            
            <div class="field">
                <label class="label">Polﾃｭticas</label>
                <div class="control">
                    <textarea class="textarea" name="politicas" rows="2">{{ config_agente|selectattr('chave', 'equalto', 'agente_politicas_padrao')|map(attribute='valor')|first or 'ser educado, respeitoso e prestativo' }}</textarea>
                </div>
                <p class="help">O que evitar ou respeitar</p>
            </div>
            
            <div class="field">
                <label class="label">Tarefa</label>
                <div class="control">
                    <textarea class="textarea" name="tarefa" rows="2">{{ config_agente|selectattr('chave', 'equalto', 'agente_tarefa_padrao')|map(attribute='valor')|first or 'responder perguntas de forma clara e objetiva' }}</textarea>
                </div>
                <p class="help">O que deve fazer na prﾃ｡tica</p>
            </div>
            
            <div class="field">
                <label class="label">Objetivo Explﾃｭcito</label>
                <div class="control">
                    <textarea class="textarea" name="objetivo_explicito" rows="2">{{ config_agente|selectattr('chave', 'equalto', 'agente_objetivo_explicito_padrao')|map(attribute='valor')|first or 'fornecer informaﾃｧﾃｵes ﾃｺteis e precisas' }}</textarea>
                </div>
                <p class="help">Como deve entregar valor</p>
            </div>
            
            <div class="field">
                <label class="label">Pﾃｺblico-Alvo</label>
                <div class="control">
                    <input class="input" type="text" name="publico" 
                           value="{{ config_agente|selectattr('chave', 'equalto', 'agente_publico_padrao')|map(attribute='valor')|first or 'usuﾃ｡rios em geral' }}">
                </div>
                <p class="help">Para quem estﾃ｡ falando</p>
            </div>
            
            <div class="field">
                <label class="label">Restriﾃｧﾃｵes</label>
                <div class="control">
                    <textarea class="textarea" name="restricoes" rows="2">{{ config_agente|selectattr('chave', 'equalto', 'agente_restricoes_padrao')|map(attribute='valor')|first or 'responder em portuguﾃｪs brasileiro, ser conciso' }}</textarea>
                </div>
                <p class="help">Limites tﾃｩcnicos e de estilo</p>
            </div>
            
        <div class="field">
            <div class="control">
                <button type="submit" class="button is-medium" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; font-weight: 600; border-radius: 8px;">
                    <span class="icon"><i class="fas fa-save"></i></span>
                    <span>Salvar Configuraﾃｧﾃｵes</span>
                </button>
            </div>
        </div>
        </form>
    </div>

<!-- Configuraﾃｧﾃｵes Gerais -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fas fa-cogs" style="color: #6b7280;"></i> Configuraﾃｧﾃｵes Gerais
    </h2>
        
        <form method="POST" action="/configuracoes/salvar-geral">
            <div class="field">
                <label class="label">Diretﾃｳrio de Uploads</label>
                <div class="control">
                    <input class="input" type="text" name="diretorio_uploads" 
                           value="{{ config_geral|selectattr('chave', 'equalto', 'sistema_diretorio_uploads')|map(attribute='valor')|first or './uploads' }}">
                </div>
            </div>
            
            <div class="field">
                <label class="label">Tamanho Mﾃ｡ximo de Imagem (MB)</label>
                <div class="control">
                    <input class="input" type="number" name="max_tamanho_imagem_mb" 
                           value="{{ config_geral|selectattr('chave', 'equalto', 'sistema_max_tamanho_imagem_mb')|map(attribute='valor')|first or '10' }}">
                </div>
            </div>
            
            <div class="field">
                <label class="label">Qualidade JPEG (1-100)</label>
                <div class="control">
                    <input class="input" type="number" min="1" max="100" name="qualidade_jpeg" 
                           value="{{ config_geral|selectattr('chave', 'equalto', 'sistema_qualidade_jpeg')|map(attribute='valor')|first or '85' }}">
                </div>
                <p class="help">Qualidade das imagens salvas. Maior = melhor qualidade, maior tamanho</p>
            </div>
            
        <div class="field">
            <div class="control">
                <button type="submit" class="button is-medium" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; font-weight: 600; border-radius: 8px;">
                    <span class="icon"><i class="fas fa-save"></i></span>
                    <span>Salvar Configuraﾃｧﾃｵes</span>
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Configuraﾃｧﾃｵes de Sessﾃ｣o WhatsApp -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fab fa-whatsapp" style="color: #25D366;"></i> Sessﾃ｣o WhatsApp
    </h2>
    <p style="color: #6b7280; margin-bottom: 1.5rem; line-height: 1.7;">
        <i class="fas fa-info-circle"></i> Configuraﾃｧﾃｵes relacionadas ﾃs conexﾃｵes WhatsApp
    </p>
        
    <form method="POST" action="/configuracoes/salvar-sessao">
        <div class="columns">
            <div class="column">
                <div class="field">
                    <label class="label">Diretﾃｳrio de Sessﾃｵes</label>
                    <div class="control">
                        <input class="input" type="text" name="sessao_diretorio" 
                               value="{{ config_sessao|selectattr('chave', 'equalto', 'sessao_diretorio')|map(attribute='valor')|first or './sessoes' }}">
                    </div>
                    <p class="help">Onde os dados das sessﾃｵes WhatsApp sﾃ｣o armazenados</p>
                </div>
            </div>
            
            <div class="column">
                <div class="field">
                    <label class="label">Delay History Sync (segundos)</label>
                    <div class="control">
                        <input class="input" type="number" min="1" max="60" name="history_sync_delay" 
                               value="{{ config_sessao|selectattr('chave', 'equalto', 'sessao_history_sync_delay')|map(attribute='valor')|first or '5' }}">
                    </div>
                    <p class="help">Segundos para ignorar mensagens antigas ao conectar</p>
                </div>
            </div>
        </div>
        
        <div class="field">
            <div class="control">
                <button type="submit" class="button is-medium" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none; font-weight: 600; border-radius: 8px;">
                    <span class="icon"><i class="fas fa-save"></i></span>
                    <span>Salvar Configuraﾃｧﾃｵes</span>
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Configuraﾃｧﾃｵes Avanﾃｧadas do Agente -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fas fa-sliders-h" style="color: #C75B9B;"></i> Agente - Configuraﾃｧﾃｵes Avanﾃｧadas
    </h2>
    <p style="color: #6b7280; margin-bottom: 1.5rem; line-height: 1.7;">
        <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Configuraﾃｧﾃｵes avanﾃｧadas que afetam o comportamento dos agentes. Altere com cuidado.
    </p>
        
    <form method="POST" action="/configuracoes/salvar-agente-avancado">
        <div class="columns">
            <div class="column is-6">
                <div class="field">
                    <label class="label">Mﾃ｡ximo de Ferramentas por Agente</label>
                    <div class="control">
                        <input class="input" type="number" min="1" max="50" name="max_ferramentas" 
                               value="{{ config_agente|selectattr('chave', 'equalto', 'agente_max_ferramentas')|map(attribute='valor')|first or '20' }}">
                    </div>
                    <p class="help">Limite de ferramentas que cada agente pode ter</p>
                </div>
            </div>
            
            <div class="column is-6">
                <div class="field">
                    <label class="label">Mﾃ｡ximo de Iteraﾃｧﾃｵes (Loop)</label>
                    <div class="control">
                        <input class="input" type="number" min="1" max="30" name="max_iteracoes" 
                               value="{{ config_agente|selectattr('chave', 'equalto', 'agente_max_iteracoes_loop')|map(attribute='valor')|first or '10' }}">
                    </div>
                    <p class="help">Limite de chamadas de ferramentas por mensagem</p>
                </div>
            </div>
        </div>
        
        <div class="columns">
            <div class="column is-6">
                <div class="field">
                    <label class="label">Histﾃｳrico de Mensagens</label>
                    <div class="control">
                        <input class="input" type="number" min="1" max="50" name="historico_mensagens" 
                               value="{{ config_agente|selectattr('chave', 'equalto', 'agente_historico_mensagens')|map(attribute='valor')|first or '10' }}">
                    </div>
                    <p class="help">Mensagens anteriores enviadas ao LLM como contexto</p>
                </div>
            </div>
            
            <div class="column is-6">
                <div class="field">
                    <label class="label">Resultados RAG Padrﾃ｣o</label>
                    <div class="control">
                        <input class="input" type="number" min="1" max="20" name="rag_resultados" 
                               value="{{ config_agente|selectattr('chave', 'equalto', 'agente_rag_resultados_padrao')|map(attribute='valor')|first or '3' }}">
                    </div>
                    <p class="help">Nﾃｺmero de resultados na busca de base de conhecimento</p>
                </div>
            </div>
        </div>
        
        <div class="field">
            <div class="control">
                <button type="submit" class="button is-medium" style="background: linear-gradient(135deg, #C75B9B 0%, #5B4E9B 100%); color: white; border: none; font-weight: 600; border-radius: 8px;">
                    <span class="icon"><i class="fas fa-save"></i></span>
                    <span>Salvar Configuraﾃｧﾃｵes Avanﾃｧadas</span>
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Configuraﾃｧﾃｵes de ﾃ「dio/Transcriﾃｧﾃ｣o -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fas fa-microphone" style="color: #ec4899;"></i> ﾃ「dio - Transcriﾃｧﾃ｣o (Whisper)
    </h2>
    <p style="color: #6b7280; margin-bottom: 1.5rem; line-height: 1.7;">
        <i class="fas fa-info-circle"></i> Configuraﾃｧﾃｵes para transcriﾃｧﾃ｣o de mensagens de ﾃ｡udio usando Whisper (Groq ou OpenAI)
    </p>
        
    <form method="POST" action="/configuracoes/salvar-audio">
        <div class="columns">
            <div class="column is-6">
                <div class="field">
                    <label class="label">
                        <input type="checkbox" name="transcricao_habilitado" value="true"
                               {% if config_audio|selectattr('chave', 'equalto', 'audio_transcricao_habilitado')|map(attribute='valor')|first != 'false' %}checked{% endif %}>
                        Habilitar Transcriﾃｧﾃ｣o de ﾃ「dio
                    </label>
                    <p class="help">Transcreve automaticamente mensagens de ﾃ｡udio recebidas</p>
                </div>
            </div>
            <div class="column is-6">
                <div class="field">
                    <label class="label">
                        <input type="checkbox" name="responder_habilitado" value="true"
                               {% if config_audio|selectattr('chave', 'equalto', 'audio_responder_habilitado')|map(attribute='valor')|first != 'false' %}checked{% endif %}>
                        Responder Mensagens de ﾃ「dio
                    </label>
                    <p class="help">Processa o ﾃ｡udio transcrito com o agente e responde</p>
                </div>
            </div>
        </div>
        
        <div class="columns">
            <div class="column">
                <div class="field">
                    <label class="label">Provedor</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select name="provedor" id="audio_provedor" onchange="atualizarModelosAudio()">
                                <option value="groq" {% if config_audio|selectattr('chave', 'equalto', 'audio_transcricao_provedor')|map(attribute='valor')|first == 'groq' %}selected{% endif %}>Groq (Rﾃ｡pido e Barato)</option>
                                <option value="openai" {% if config_audio|selectattr('chave', 'equalto', 'audio_transcricao_provedor')|map(attribute='valor')|first == 'openai' %}selected{% endif %}>OpenAI</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="column">
                <div class="field">
                    <label class="label">Modelo</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select name="modelo" id="audio_modelo">
                                <!-- Groq -->
                                <option value="whisper-large-v3-turbo" data-provedor="groq" {% if config_audio|selectattr('chave', 'equalto', 'audio_transcricao_modelo')|map(attribute='valor')|first == 'whisper-large-v3-turbo' %}selected{% endif %}>whisper-large-v3-turbo ($0.04/h)</option>
                                <option value="whisper-large-v3" data-provedor="groq" {% if config_audio|selectattr('chave', 'equalto', 'audio_transcricao_modelo')|map(attribute='valor')|first == 'whisper-large-v3' %}selected{% endif %}>whisper-large-v3 ($0.11/h)</option>
                                <!-- OpenAI -->
                                <option value="whisper-1" data-provedor="openai" {% if config_audio|selectattr('chave', 'equalto', 'audio_transcricao_modelo')|map(attribute='valor')|first == 'whisper-1' %}selected{% endif %}>whisper-1</option>
                                <option value="gpt-4o-transcribe" data-provedor="openai" {% if config_audio|selectattr('chave', 'equalto', 'audio_transcricao_modelo')|map(attribute='valor')|first == 'gpt-4o-transcribe' %}selected{% endif %}>gpt-4o-transcribe</option>
                                <option value="gpt-4o-mini-transcribe" data-provedor="openai" {% if config_audio|selectattr('chave', 'equalto', 'audio_transcricao_modelo')|map(attribute='valor')|first == 'gpt-4o-mini-transcribe' %}selected{% endif %}>gpt-4o-mini-transcribe</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="column">
                <div class="field">
                    <label class="label">Idioma (ISO 639-1)</label>
                    <div class="control">
                        <input class="input" type="text" name="idioma" placeholder="pt, en, es..."
                               value="{{ config_audio|selectattr('chave', 'equalto', 'audio_transcricao_idioma')|map(attribute='valor')|first or 'pt' }}">
                    </div>
                    <p class="help">pt = Portuguﾃｪs, en = Inglﾃｪs, es = Espanhol</p>
                </div>
            </div>
        </div>
        
        <div class="columns">
            <div class="column">
                <div class="field">
                    <label class="label">Temperatura</label>
                    <div class="control">
                        <input class="input" type="number" step="0.1" min="0" max="1" name="temperatura"
                               value="{{ config_audio|selectattr('chave', 'equalto', 'audio_transcricao_temperatura')|map(attribute='valor')|first or '0.0' }}">
                    </div>
                    <p class="help">0.0 recomendado para melhor precisﾃ｣o</p>
                </div>
            </div>
            
            <div class="column">
                <div class="field">
                    <label class="label">Timeout (segundos)</label>
                    <div class="control">
                        <input class="input" type="number" min="10" max="300" name="timeout"
                               value="{{ config_audio|selectattr('chave', 'equalto', 'audio_transcricao_timeout')|map(attribute='valor')|first or '60' }}">
                    </div>
                </div>
            </div>
            
            <div class="column">
                <div class="field" id="groq_key_field">
                    <label class="label">Groq API Key</label>
                    <div class="control">
                        <input class="input" type="password" name="groq_api_key" placeholder="gsk_...">
                    </div>
                    <p class="help">Deixe vazio para manter a atual</p>
                </div>
                <div class="field" id="openai_key_field" style="display: none;">
                    <label class="label">OpenAI API Key</label>
                    <div class="control">
                        <input class="input" type="password" name="openai_api_key" placeholder="sk-...">
                    </div>
                    <p class="help">Deixe vazio para manter a atual</p>
                </div>
            </div>
        </div>
        
        <div class="field">
            <label class="label">Prompt de Contexto (opcional)</label>
            <div class="control">
                <textarea class="textarea" name="prompt" rows="2" placeholder="Nomes prﾃｳprios, siglas, termos tﾃｩcnicos...">{{ config_audio|selectattr('chave', 'equalto', 'audio_transcricao_prompt')|map(attribute='valor')|first or '' }}</textarea>
            </div>
            <p class="help">Ajuda o modelo a reconhecer palavras especﾃｭficas</p>
        </div>
        
        <div class="field">
            <div class="control">
                <button type="submit" class="button is-medium" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; border: none; font-weight: 600; border-radius: 8px;">
                    <span class="icon"><i class="fas fa-save"></i></span>
                    <span>Salvar Configuraﾃｧﾃｵes</span>
                </button>
            </div>
        </div>
    </form>
</div>

<script>
function atualizarModelosAudio() {
    const provedor = document.getElementById('audio_provedor').value;
    const modeloSelect = document.getElementById('audio_modelo');
    const opcoes = modeloSelect.querySelectorAll('option');
    
    // Mostrar/esconder modelos por provedor
    opcoes.forEach(opcao => {
        if (opcao.dataset.provedor === provedor) {
            opcao.style.display = '';
        } else {
            opcao.style.display = 'none';
        }
    });
    
    // Selecionar primeiro modelo visﾃｭvel
    const primeiroVisivel = Array.from(opcoes).find(o => o.dataset.provedor === provedor);
    if (primeiroVisivel) {
        modeloSelect.value = primeiroVisivel.value;
    }
    
    // Mostrar/esconder campo de API Key correto
    const groqField = document.getElementById('groq_key_field');
    const openaiField = document.getElementById('openai_key_field');
    
    if (provedor === 'groq') {
        groqField.style.display = '';
        openaiField.style.display = 'none';
    } else {
        groqField.style.display = 'none';
        openaiField.style.display = '';
    }
}

// Inicializar na carga da pﾃ｡gina
document.addEventListener('DOMContentLoaded', function() {
    atualizarModelosAudio();
    atualizarProvedorLocal();
});

function atualizarProvedorLocal() {
    const provedorPadrao = document.getElementById('provedor_padrao');
    const provedorLocalField = document.getElementById('provedor_local_field');
    
    if (provedorPadrao && provedorLocalField) {
        if (provedorPadrao.value === 'local') {
            provedorLocalField.style.display = '';
        } else {
            provedorLocalField.style.display = 'none';
        }
    }
}
</script>

<!-- Configuraﾃｧﾃｵes MCP -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fas fa-plug" style="color: #06b6d4;"></i> MCP (Model Context Protocol)
    </h2>
    <p style="color: #6b7280; margin-bottom: 1.5rem; line-height: 1.7;">
        <i class="fas fa-info-circle"></i> Configuraﾃｧﾃｵes para clientes MCP (servidores de contexto externos)
    </p>
        
    <form method="POST" action="/configuracoes/salvar-mcp">
        <div class="columns">
            <div class="column">
                <div class="field">
                    <label class="label">Mﾃ｡ximo de Clientes por Agente</label>
                    <div class="control">
                        <input class="input" type="number" min="1" max="20" name="max_clients" 
                               value="{{ config_mcp|selectattr('chave', 'equalto', 'mcp_max_clients_por_agente')|map(attribute='valor')|first or '5' }}">
                    </div>
                    <p class="help">Limite de servidores MCP que cada agente pode conectar</p>
                </div>
            </div>
            
            <div class="column">
                <div class="field">
                    <label class="label">Timeout Execuﾃｧﾃ｣o (segundos)</label>
                    <div class="control">
                        <input class="input" type="number" min="10" max="300" name="timeout_execucao" 
                               value="{{ config_mcp|selectattr('chave', 'equalto', 'mcp_timeout_execucao')|map(attribute='valor')|first or '60' }}">
                    </div>
                    <p class="help">Tempo mﾃ｡ximo para execuﾃｧﾃ｣o de tools MCP</p>
                </div>
            </div>
        </div>
        
        <div class="field">
            <div class="control">
                <button type="submit" class="button is-medium" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; border: none; font-weight: 600; border-radius: 8px;">
                    <span class="icon"><i class="fas fa-save"></i></span>
                    <span>Salvar Configuraﾃｧﾃｵes</span>
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Configuraﾃｧﾃｵes de Ferramentas -->
<div class="box" style="margin-bottom: 2rem;">
    <h2 class="title is-5" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
        <i class="fas fa-tools" style="color: #f59e0b;"></i> Ferramentas - Timeouts
    </h2>
    <p style="color: #6b7280; margin-bottom: 1.5rem; line-height: 1.7;">
        <i class="fas fa-info-circle"></i> Configure os timeouts para requisiﾃｧﾃｵes HTTP das ferramentas
    </p>
        
    <form method="POST" action="/configuracoes/salvar-ferramenta">
        <div class="columns">
            <div class="column">
                <div class="field">
                    <label class="label">Timeout HTTP (segundos)</label>
                    <div class="control">
                        <input class="input" type="number" min="5" max="120" name="timeout_http" 
                               value="{{ config_ferramenta|selectattr('chave', 'equalto', 'ferramenta_timeout_http')|map(attribute='valor')|first or '30' }}">
                    </div>
                    <p class="help">Tempo mﾃ｡ximo para requisiﾃｧﾃｵes HTTP normais</p>
                </div>
            </div>
            
            <div class="column">
                <div class="field">
                    <label class="label">Timeout Download (segundos)</label>
                    <div class="control">
                        <input class="input" type="number" min="10" max="300" name="timeout_download" 
                               value="{{ config_ferramenta|selectattr('chave', 'equalto', 'ferramenta_timeout_download')|map(attribute='valor')|first or '60' }}">
                    </div>
                    <p class="help">Tempo mﾃ｡ximo para download de mﾃｭdia (vﾃｭdeo/documento)</p>
                </div>
            </div>
            
            <div class="column">
                <div class="field">
                    <label class="label">Timeout Teste (segundos)</label>
                    <div class="control">
                        <input class="input" type="number" min="5" max="60" name="timeout_teste" 
                               value="{{ config_ferramenta|selectattr('chave', 'equalto', 'ferramenta_timeout_teste')|map(attribute='valor')|first or '10' }}">
                    </div>
                    <p class="help">Tempo mﾃ｡ximo para testes no wizard de criaﾃｧﾃ｣o</p>
                </div>
            </div>
        </div>
        
        <div class="field">
            <div class="control">
                <button type="submit" class="button is-medium" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; font-weight: 600; border-radius: 8px;">
                    <span class="icon"><i class="fas fa-save"></i></span>
                    <span>Salvar Configuraﾃｧﾃｵes</span>
                </button>
            </div>
        </div>
    </form>
</div>

{% endblock %}
